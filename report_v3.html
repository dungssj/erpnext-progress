<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Tình trạng Dự án</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff; /* Nền trắng mặc định */
            color: #111827; /* Chữ đen mặc định */
        }

        .task-node {
            display: grid;
            grid-template-rows: auto 0fr;
            transition: grid-template-rows 0.3s ease-out;
        }

        .task-node.open {
            grid-template-rows: auto 1fr;
        }

        .task-content-wrapper {
            overflow: hidden;
        }
        
        .task-node.open .toggle-icon {
            transform: rotate(90deg);
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .task-node.is-leaf .toggle-icon {
            visibility: hidden;
        }

        /* --- Comment Content Styling --- */
        .comment-content p { margin-bottom: 0.5rem; }
        .comment-content p:last-child { margin-bottom: 0; }
        .comment-content strong { font-weight: 600; }
        .comment-content em { font-style: italic; }
        .comment-content ol, .comment-content ul { padding-left: 1.25rem; margin-bottom: 0.5rem; }
        .comment-content ol { list-style-type: decimal; }
        .comment-content ul { list-style-type: disc; }
        .comment-content li { margin-bottom: 0.25rem; }
        .comment-content a { color: #2563eb; text-decoration: underline; }

        /* --- Print-friendly CSS đã được tích hợp vào thiết kế gốc --- */
        @media print {
            header { display: none !important; }
            .task-node { grid-template-rows: auto 1fr !important; }
            .toggle-icon { display: none !important; }
            .project-card, .task-entry { page-break-inside: avoid; }
        }

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header>
            <h1 class="text-3xl font-bold text-gray-800">Báo cáo Tình trạng Dự án</h1>
            <p class="text-gray-500 mt-1">Dữ liệu được cập nhật tự động từ file JSON.</p>
            <div class="mt-4 flex gap-2">
                <button id="expand-all-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Mở rộng tất cả</button>
                <button id="collapse-all-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Thu gọn tất cả</button>
            </div>
        </header>

        <main id="report-container" class="mt-8">
            <p class="text-gray-500">Đang tải dữ liệu báo cáo...</p>
        </main>
    </div>

    <script>
        // --- Helper Functions ---
        function getStatusBadge(status) {
            const s = status ? status.toLowerCase() : '';
            const styles = {
                'completed': { border: 'border-green-400', text: 'text-green-600' },
                'working': { border: 'border-yellow-500', text: 'text-yellow-700' },
                'pending review': { border: 'border-purple-400', text: 'text-purple-600' },
                'open': { border: 'border-blue-400', text: 'text-blue-600' },
                'default': { border: 'border-gray-400', text: 'text-gray-600' }
            };
            const style = styles[s] || styles['default'];
            return `<span class="inline-block px-2 py-0.5 text-xs font-medium border ${style.border} ${style.text} rounded-full">${status}</span>`;
        }

        function getInitials(email) {
            if (!email) return '??';
            const namePart = email.split('@')[0];
            const parts = namePart.split(/[._-]/);
            if (parts.length > 1) {
                return (parts[0][0] + (parts[parts.length - 1][0] || '')).toUpperCase();
            }
            return (namePart.substring(0, 2) || '??').toUpperCase();
        }

        function getUserColor(owner) {
            const colors = [
                { border: 'border-pink-400', text: 'text-pink-600' }, { border: 'border-indigo-400', text: 'text-indigo-600' },
                { border: 'border-blue-400', text: 'text-blue-600' }, { border: 'border-green-400', text: 'text-green-600' },
                { border: 'border-yellow-500', text: 'text-yellow-600' }, { border: 'border-purple-400', text: 'text-purple-600' },
                { border: 'border-red-400', text: 'text-red-600' }, { border: 'border-teal-400', text: 'text-teal-600' },
            ];
            let hash = 0;
            for (let i = 0; i < (owner || '').length; i++) {
                hash = owner.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash % colors.length);
            return colors[index];
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            return new Date(dateTimeString).toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        // --- Main Render Functions ---
        function renderTaskTree(tasks, level = 0) {
            if (!tasks || tasks.length === 0) return '';
            
            const paddingLeft = `${level * 1.5}rem`; // Thụt lề 24px mỗi cấp
            let html = `<div class="space-y-2" style="padding-left: ${paddingLeft};">`;
            tasks.forEach(task => {
                const hasChildren = task.children && task.children.length > 0;
                const hasComments = task.comments && task.comments.length > 0;
                const isLeaf = !hasChildren && !hasComments;

                const commentsHtml = !hasComments ? '' : `<div class="mt-3 border-t border-gray-200">${task.comments.map(comment => {
                    const color = getUserColor(comment.comment_owner);
                    return `
                    <div class="comment-item py-3 border-b border-gray-200">
                        <div class="flex items-center text-xs text-gray-500 mb-1.5">
                             <div class="w-6 h-6 mr-2 rounded-full border-2 ${color.border} ${color.text} flex items-center justify-center font-bold text-xs">
                                ${getInitials(comment.comment_owner)}
                            </div>
                            <span class="font-semibold text-gray-800">${comment.comment_owner.split('@')[0]}</span>
                            <span class="mx-1.5 text-gray-400">·</span>
                            <span>${formatDateTime(comment.comment_time)}</span>
                        </div>
                        <div class="comment-content text-sm text-gray-700 pl-8">
                            ${comment.comment_html || ''}
                        </div>
                    </div>
                `}).join('')}</div>`;

                const childrenHtml = hasChildren ? renderTaskTree(task.children, level + 1) : '';
                
                html += `
                    <div class="task-entry border border-gray-200 rounded-lg bg-white">
                        <div class="task-node ${isLeaf ? 'is-leaf' : ''}">
                            <div class="task-header p-2 cursor-pointer hover:bg-gray-50 flex items-center justify-between">
                                <div class="flex items-center gap-2 flex-grow min-w-0">
                                    <span class="toggle-icon text-gray-400 hover:text-gray-800 flex-shrink-0">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                    </span>
                                    <span class="font-medium text-gray-800 text-sm truncate" title="${task.task_subject}">${task.task_subject}</span>
                                </div>
                                <div class="flex items-center gap-3 text-xs text-gray-500 pr-2 flex-shrink-0">
                                     <span>${task.task_id}</span>
                                     ${getStatusBadge(task.task_status)}
                                </div>
                            </div>
                            <div class="task-content-wrapper">
                                <div class="p-3">
                                    ${commentsHtml}
                                    ${childrenHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function renderReport(data) {
            const container = document.getElementById('report-container');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Không có dữ liệu dự án.</p>';
                return;
            }

            let reportHtml = '';
            data.forEach(project => {
                const tasksHtml = renderTaskTree(project.tasks, 0);
                reportHtml += `
                    <div class="project-card border border-gray-300 rounded-lg overflow-hidden mb-8">
                        <div class="p-4 bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="uppercase tracking-wide text-xs text-indigo-600 font-semibold">${project.project_company}</div>
                                    <h2 class="text-xl font-bold text-gray-900">${project.project_name}</h2>
                                    <p class="text-gray-500 text-xs mt-0.5">${project.project_id}</p>
                                </div>
                                ${getStatusBadge(project.project_status)}
                            </div>
                            <div class="mt-3">
                                <p class="text-xs font-medium text-gray-600 mb-1">Tiến độ tổng thể</p>
                                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-indigo-500 h-2 rounded-full" style="width: ${project.project_percent}%"></div></div>
                                <p class="text-right text-xs text-gray-500 mt-1">${project.project_percent}%</p>
                            </div>
                        </div>
                        <div class="px-4 py-3 bg-white border-t border-gray-200">
                             <h3 class="text-base font-semibold text-gray-700 mb-3">Danh sách công việc</h3>
                             <div class="task-tree">${tasksHtml}</div>
                        </div>
                    </div>
                `;
            });
            const template = document.createElement('template');
            template.innerHTML = reportHtml.trim();
            container.innerHTML = ''; 
            container.appendChild(template.content.cloneNode(true));
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('click', function(e) {
            const taskHeader = e.target.closest('.task-header');
            if (taskHeader) {
                const taskNode = taskHeader.closest('.task-node');
                if (taskNode && !taskNode.classList.contains('is-leaf')) {
                    taskNode.classList.toggle('open');
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const expandAllBtn = document.getElementById('expand-all-btn');
            const collapseAllBtn = document.getElementById('collapse-all-btn');
            const reportContainer = document.getElementById('report-container');

            expandAllBtn.addEventListener('click', () => {
                reportContainer.querySelectorAll('.task-node:not(.is-leaf)').forEach(task => task.classList.add('open'));
            });

            collapseAllBtn.addEventListener('click', () => {
                reportContainer.querySelectorAll('.task-node').forEach(task => task.classList.remove('open'));
            });

            fetch('out/report2.json')
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => renderReport(data))
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu báo cáo:', error);
                    reportContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"><p class="font-bold">Không thể tải dữ liệu</p><p>Đã xảy ra lỗi khi cố gắng tải file <code>out/report.json</code>. Vui lòng kiểm tra lại đường dẫn và đảm bảo file tồn tại.</p></div>`;
                });
        });
    </script>
</body>
</html>
